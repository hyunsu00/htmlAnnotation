<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="./main.js" type="module"></script>
  <script src="./action.js" type="module"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      /* 세로 방향 정렬 */
    }

    ul.topnav {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #333;
      cursor: pointer;
      flex-shrink: 0;
      /* 크기가 줄어들지 않도록 설정 */
      z-index: 1000;
      /* 다른 요소들 위에 위치하도록 설정 */
    }

    ul.topnav li {
      float: left;
    }

    ul.topnav li a {
      display: block;
      color: white;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
    }

    ul.topnav li a:hover:not(.active) {
      background-color: #111;
    }

    ul.topnav li a.active {
      background-color: #04aa6d;
    }

    ul.topnav li.right {
      float: right;
    }

    ul.topnav li a.disabled {
      pointer-events: none;
      opacity: 0.5;
      background-color: #555 !important;
      color: #ccc !important;
    }
    @media screen and (max-width: 600px) {

      ul.topnav li.right,
      ul.topnav li {
        float: none;
      }
    }

    #pdfjs_wrap {
      flex-grow: 1;
      /* 남은 공간을 모두 차지 */
      width: 100%;
      /* 부모 컨테이너의 너비 100% */
      border: none;
      overflow-y: scroll;
      /* 세로 스크롤바 항상 표시 */
      overflow-x: auto;
      /* 가로 스크롤바는 필요할 때만 표시 */
      padding: 20px;
      /* 내부 여백 추가 */
      background-color: #f0f0f0;
      /* 배경색 추가 */
      box-sizing: border-box;
      /* padding을 포함한 크기 계산 */
    }

    .page {
      position: relative;
      width: 816px;
      height: 1056px;
      border: 1px solid #ddd;
      margin: 10px auto;
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      /* 페이지 크기가 줄어들지 않도록 고정 */
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
    }

    .page img {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;  
    }

    .textLayer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 10;  
      pointer-events: auto;
    }

    .text-span {
      position: absolute;
      white-space: pre;
      color: transparent;  
      font-family: Arial, sans-serif;
      font-size: 1px;
      line-height: 1;
      cursor: text;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      transform-origin: left bottom;
      overflow: visible;
      pointer-events: auto;
      z-index: 20;
      /* 텍스트가 최상위에 오도록 */
    }

    .text-span::selection {
      background-color: rgba(0, 123, 255, 0.3);
      color: transparent;
    }

    .text-span::-moz-selection {
      background-color: rgba(0, 123, 255, 0.3);
      color: transparent;
    }

    #viewerContainer {
      width: 100%;
      height: 100%;
      overflow: visible;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
    }

    .pdfViewer {
      width: 100%;
      height: 100%;
      overflow: visible;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      cursor: text;
    }

    .annotationLayer {
      position: absolute;
      left: 0;
      top: 0;
      z-index: 25;
      pointer-events: auto;
    }
  </style>
  <title>webpdfsdk-viewer</title>
</head>

<body>
  <ul class="topnav">
    <li><a id="AREA">사각형</a></li>
    <li><a id="CIRCLE">원</a></li>
    <li><a id="HIGHLIGHT">형광펜</a></li>
    <li><a id="UNDERLINE">밑줄</a></li>
    <li><a id="STRIKEOUT">취소선</a></li>
    <li><a id="LINE">선</a></li>
    <li><a id="PEN">펜</a></li>
    <li><a id="TEXT">텍스트</a></li>
    <li><a id="MEMO">메모</a></li>
    <li><a id="AProperty">속성</a></li>
    <li class="right"><a id="AOpenJson">주석열기...</a></li>
    <li class="right"><a id="ASaveAnnotation">주석저장</a></li>
    <li class="right"><a id="ADownloadAnnotation">주석다운로드</a></li>
    <li class="right"><a id="ARedo">다시실행</a></li>
    <li class="right"><a id="AUndo">실행취소</a></li>
  </ul>
  <div id="pdfjs_wrap">
    <div id="viewerContainer" tabindex="0">
      <div id="viewer" class="pdfViewer">
        <!-- 페이지들이 여기에 동적으로 로드됩니다 -->
      </div>
    </div>
  </div>

  <script type="module">
    import "../dist/webPdfLib.js";
    const webPdfApp = webPdfLib["default"];

    async function loadPage(pageNum) {
      try {
        const response = await fetch(`samples/page${pageNum}.html`);
        const text = await response.text();
        
        // HTML에서 body 내용만 추출
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        const pageContent = doc.querySelector('.page');
        
        if (pageContent) {
          // 이미지 src 경로 업데이트
          const img = pageContent.querySelector('img');
          if (img) {
            img.src = `samples/page${pageNum}.png`;
          }

          var docId = '/dist/libs/pdfjs/web/compressed.tracemonkey-pldi-09.pdf';
          var parentNode = pageContent;
          var canvasWrapper = pageContent.querySelector('.canvasWrapper');
          var id = pageNum;
          var pdfPage = null; // 실제 PDF 페이지 객체로 교체 필요
          var scale = 1.0;
          webPdfApp.getAnnotationManager().render(
            docId,
            parentNode,
            canvasWrapper,
            id,
            pdfPage,
            scale
          );
          // // textLayer 찾기
          // const textLayer = pageContent.querySelector('.textLayer');
          // if (textLayer) {
          //   // annotationLayer SVG 생성
          //   const annotationLayer = document.createElement('svg');
          //   annotationLayer.className = 'annotationLayer';
          //   annotationLayer.setAttribute('width', '612');
          //   annotationLayer.setAttribute('height', '792');
          //   annotationLayer.setAttribute('data-pdf-annotate-container', 'true');
          //   annotationLayer.setAttribute('data-pdf-annotate-viewport', '{"viewBox":[0,0,612,792],"scale":1,"rotation":0,"offsetX":0,"offsetY":0,"transform":[1,0,0,-1,0,792],"width":612,"height":792}');
          //   annotationLayer.setAttribute('data-pdf-annotate-document', '/dist/libs/pdfjs/web/compressed.tracemonkey-pldi-09.pdf');
          //   annotationLayer.setAttribute('data-pdf-annotate-page', pageNum.toString());
          //   annotationLayer.style.width = '816px';
          //   annotationLayer.style.height = '1056px';
            
          //   console.log('annotationLayer created for page', pageNum, annotationLayer);
            
          //   // textLayer 앞에 annotationLayer 삽입
          //   pageContent.insertBefore(annotationLayer, textLayer);
          // }

          return pageContent;
        }
        return null;
      } catch (error) {
        console.error(`Error loading page${pageNum}:`, error);
        return null;
      }
    }

    async function loadAllPages() {
      const viewer = document.getElementById('viewer');
      
      for (let i = 1; i <= 14; i++) {
        const pageElement = await loadPage(i);
        if (pageElement) {
          viewer.appendChild(pageElement);
        }
      }
    }

    // 페이지 로드 완료 후 모든 페이지 로드
    document.addEventListener('DOMContentLoaded', loadAllPages);
  </script>
</body>

</html>