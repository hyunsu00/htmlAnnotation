<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="./main.js" type="module"></script>
  <script src="./action.js" type="module"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      /* 세로 방향 정렬 */
    }

    ul.topnav {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #333;
      cursor: pointer;
      flex-shrink: 0;
      /* 크기가 줄어들지 않도록 설정 */
      z-index: 1000;
      /* 다른 요소들 위에 위치하도록 설정 */
    }

    ul.topnav li {
      float: left;
    }

    ul.topnav li a {
      display: block;
      color: white;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
    }

    ul.topnav li a:hover:not(.active) {
      background-color: #111;
    }

    ul.topnav li a.active {
      background-color: #04aa6d;
    }

    ul.topnav li.right {
      float: right;
    }

    ul.topnav li a.disabled {
      pointer-events: none;
      opacity: 0.5;
      background-color: #555 !important;
      color: #ccc !important;
    }
    @media screen and (max-width: 600px) {

      ul.topnav li.right,
      ul.topnav li {
        float: none;
      }
    }
  </style>
  <link rel="stylesheet" href="./main.css" />
  <title>AnnotationTester</title>
</head>

<body>
  <ul class="topnav">
    <li><a id="AREA">사각형</a></li>
    <li><a id="CIRCLE">원</a></li>
    <li><a id="HIGHLIGHT">형광펜</a></li>
    <li><a id="UNDERLINE">밑줄</a></li>
    <li><a id="STRIKEOUT">취소선</a></li>
    <li><a id="LINE">선</a></li>
    <li><a id="PEN">펜</a></li>
    <li><a id="TEXT">텍스트</a></li>
    <li><a id="MEMO">메모</a></li>
    <li><a id="AProperty">속성</a></li>
    <li class="right"><a id="AOpenJson">주석열기...</a></li>
    <li class="right"><a id="ASaveAnnotation">주석저장</a></li>
    <li class="right"><a id="ADownloadAnnotation">주석다운로드</a></li>
    <li class="right"><a id="ARedo">다시실행</a></li>
    <li class="right"><a id="AUndo">실행취소</a></li>
  </ul>
  <div id="pdfjs_wrap">
    <div id="viewerContainer" tabindex="0">
      <div id="viewer" class="pdfViewer">
        <!-- 페이지들이 여기에 동적으로 로드됩니다 -->
      </div>
    </div>
  </div>

  <script type="module">
    import "../dist/annotationLib.js";
    const webPdfApp = annotationLib["default"];

    async function loadPage(pageNum) {
      try {
        const response = await fetch(`samples/page${pageNum}.html`);
        const text = await response.text();
        
        // HTML에서 body 내용만 추출
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        const pageContent = doc.querySelector('.page');
        
        if (pageContent) {
          // 이미지 src 경로 업데이트
          const img = pageContent.querySelector('img');
          if (img) {
            img.src = `samples/page${pageNum}.png`;
          }

          const docId = '/dist/libs/pdfjs/web/compressed.tracemonkey-pldi-09.pdf';
          const parentNode = pageContent;
          const pageId = pageNum;
          const renderSize = {
            width: pageContent.style.width,
            height: pageContent.style.height
          };
          const pageSize = {
            width: pageContent.getAttribute('data-page-size-width'),
            height: pageContent.getAttribute('data-page-size-height')
          };
          const scale = 1.0;
          const rotation = 0;          
          webPdfApp.getAnnotationManager().render(
            docId,
            parentNode,
            pageId,
            renderSize,
            pageSize,
            scale,
            rotation
          );
          return pageContent;
        }
        return null;
      } catch (error) {
        console.error(`Error loading page${pageNum}:`, error);
        return null;
      }
    }

    async function loadAllPages() {
      const viewer = document.getElementById('viewer');
      
      for (let i = 1; i <= 14; i++) {
        const pageElement = await loadPage(i);
        if (pageElement) {
          viewer.appendChild(pageElement);
        }
      }
    }

    // 페이지 로드 완료 후 모든 페이지 로드
    document.addEventListener('DOMContentLoaded', loadAllPages);
  </script>
</body>

</html>